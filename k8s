#!/bin/bash
# Temporary fix for pod egress connectivity
# Run this on the k8s node with: bash fix-pod-egress.sh

set -e

echo "üîß Applying temporary pod egress fixes..."

# Enable IP forwarding
echo "1. Enabling IP forwarding"
sudo sysctl -w net.ipv4.ip_forward=1

# Set FORWARD policy to ACCEPT  
echo "2. Setting FORWARD policy to ACCEPT"
sudo iptables -P FORWARD ACCEPT

# Add MASQUERADE rule for pod CIDR egress
echo "3. Adding MASQUERADE rule for pod CIDR (10.42.0.0/16)"
sudo iptables -t nat -C POSTROUTING -s 10.42.0.0/16 ! -d 10.42.0.0/16 -j MASQUERADE 2>/dev/null \
  || sudo iptables -t nat -A POSTROUTING -s 10.42.0.0/16 ! -d 10.42.0.0/16 -j MASQUERADE

echo "‚úÖ Temporary fixes applied!"
echo ""
echo "üß™ Test with:"
echo "kubectl run curl-pod --rm -it --image=curlimages/curl -- curl -I https://github.com/ -m 5 -v"
echo ""
echo "‚ö†Ô∏è  These changes are temporary and will be lost on reboot."
echo "If the test works, run the permanent fix script next."